<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¦åˆ©æ´»åŠ¨ - æ–‡ç« æ’è¡Œæ¦œ & åšé¥¼æŠ½å¥–</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/css/layui.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* ç”¨æˆ·ä¿¡æ¯å¡ç‰‡æ ·å¼ */
        .user-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #1E9FFF;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .user-nickname {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .user-name {
            font-size: 14px;
            color: #999;
        }
        .times-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }
        .times-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .times-number {
            font-size: 20px;
            font-weight: bold;
        }
        .login-prompt {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-prompt-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1E9FFF;
        }

        /* åšé¥¼åŒºåŸŸæ ·å¼ */
        .mooncake-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .prize-panel {
            width: 100%;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
            box-sizing: border-box;
        }
        .prize-table {
            width: 100%;
            min-width: 730px;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .prize-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .prize-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }
        .prize-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            word-wrap: break-word;
            word-break: break-word;
        }
        .prize-table tbody tr:hover {
            background: #f8f9fa;
        }
        .prize-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* é«˜äº®æˆ‘çš„æ–‡ç«  */
        .my-article-row {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        /* ç¦ç­¾æŠ•ç¥¨æ ·å¼ */
        .vote-status-card {
            background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%);
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .vote-status-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .vote-cards {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .vote-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .vote-card-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .vote-card-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .vote-card-status {
            font-size: 12px;
            color: #666;
        }
        .vote-card.voted {
            opacity: 0.6;
            position: relative;
        }
        .vote-card.voted::after {
            content: 'âœ“ å·²èµ é€';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 159, 255, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        /* æŠ•ç¥¨æ’è¡Œæ¦œæ ·å¼ */
        .vote-rank-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .vote-rank-table thead {
            background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%);
            color: white;
        }
        .vote-rank-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }
        .vote-rank-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .vote-rank-table tbody tr:hover {
            background: #fff3cd;
        }
        .vote-rank-table tbody tr:last-child td {
            border-bottom: none;
        }
        .rank-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }
        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
        .rank-other { background: #999; }

        .dice-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 30px 15px;
            position: relative;
            min-height: 400px;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* åšé¥¼åŒºåŸŸå†…çš„ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .dice-user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
        }
        .dice-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #1E9FFF;
        }
        .dice-user-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .dice-user-nickname {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .dice-user-name {
            font-size: 12px;
            color: #999;
        }
        .dice-times-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .dice-times-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        .dice-times-label {
            font-size: 12px;
            color: #666;
        }
        .dice-times-number {
            font-size: 24px;
            font-weight: bold;
            color: #1E9FFF;
        }
        .dice-times-number.remaining {
            color: #FFB800;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            max-width: 100%;
            flex-wrap: wrap;
        }
        .dice {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            box-sizing: border-box;
        }
        .dice.rolling {
            animation: roll 0.5s infinite;
        }
        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }
        .result-display {
            text-align: center;
            color: white;
            margin-top: 20px;
            max-width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        .result-prize {
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .result-level {
            font-size: 18px;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* SVGéª°å­æ ·å¼ */
        .dice-svg-container {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: nowrap;
        }
        .dice-svg {
            width: 40px;
            height: 40px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease-out;
        }
        .dice-svg.show {
            opacity: 1;
            transform: scale(1);
        }
        .history-dices .dice-svg {
            width: 24px;
            height: 24px;
            opacity: 1;
            transform: scale(1);
        }

        .history-panel {
            width: 100%;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 400px;
            box-sizing: border-box;
        }
        .history-item {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid #FFB800;
            word-wrap: break-word;
            box-sizing: border-box;
        }
        .history-time {
            color: #999;
            font-size: 11px;
        }
        .history-result {
            color: #1E9FFF;
            font-weight: bold;
            margin: 5px 0;
        }
        .history-dices {
            color: #666;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* å“åº”å¼è®¾è®¡ */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .section {
                padding: 15px;
            }
            .dice {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
            .dice-container {
                gap: 10px;
            }
            .dice-area {
                padding: 20px 10px;
                min-height: 350px;
            }
            .prize-table th,
            .prize-table td {
                padding: 8px 5px;
                font-size: 12px;
            }
            .user-card {
                flex-direction: column;
            }
        }

        @media screen and (max-width: 480px) {
            .dice {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            .result-prize {
                font-size: 24px !important;
            }
            .result-level {
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ç”¨æˆ·ä¿¡æ¯å¡ç‰‡ / ç™»å½•æç¤º -->
        <div id="userStatusSection"></div>

        <!-- æ–‡ç« æ’è¡Œæ¦œéƒ¨åˆ† -->
        <div class="section">
            <div class="section-title">
                <i class="layui-icon layui-icon-chart"></i> æ–‡ç« æ’è¡Œæ¦œ
            </div>
            <table class="layui-hide" id="articleTable" lay-filter="articleTable"></table>
        </div>

        <!-- åšé¥¼æŠ½å¥–éƒ¨åˆ† -->
        <div class="section">
            <div class="section-title">
                <i class="layui-icon layui-icon-gift"></i> åšé¥¼æŠ½å¥–
            </div>
            <div class="mooncake-section">
                <!-- å·¦ä¾§ï¼šå¥–åŠ±åˆ—è¡¨ -->
                <div class="prize-panel">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ å¥–åŠ±åˆ—è¡¨</h3>
                    <table class="prize-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">å¥–åŠ±ç­‰çº§</th>
                                <th style="width: 120px;">å¥–é¡¹åç§°</th>
                                <th style="width: 200px;">å¥–é¡¹æè¿°</th>
                                <th style="width: 80px;">ç§¯åˆ†</th>
                                <th style="width: 80px;">æ•°é‡</th>
                                <th style="width: 150px;">å¤‡æ³¨</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999; padding: 20px;">
                                    æš‚æ— å¥–åŠ±å¯æ˜¾ç¤º
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- ä¸­é—´ï¼šåšé¥¼åŒºåŸŸ -->
                <div class="dice-area">
                    <h2 style="color: white; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        ğŸ² åšé¥¼æ¸¸æˆ
                    </h2>

                    <!-- ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º -->
                    <div class="dice-user-info" id="userStatusDice">
                        <!-- ç”¨æˆ·ä¿¡æ¯å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
                    </div>

                    <div class="dice-container">
                        <div class="dice" id="dice1">?</div>
                        <div class="dice" id="dice2">?</div>
                        <div class="dice" id="dice3">?</div>
                        <div class="dice" id="dice4">?</div>
                        <div class="dice" id="dice5">?</div>
                        <div class="dice" id="dice6">?</div>
                    </div>
                    <button class="layui-btn layui-btn-danger layui-btn-lg" id="rollBtn">
                        <i class="layui-icon layui-icon-play"></i> å¼€å§‹åšé¥¼
                    </button>
                </div>

                <!-- å³ä¾§ï¼šåšé¥¼è®°å½• -->
                <div class="history-panel">
                    <h3 style="margin-bottom: 15px; color: #333;">ğŸ“œ åšé¥¼è®°å½•</h3>
                    <div id="historyList">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            æš‚æ— è®°å½•ï¼Œå¿«æ¥è¯•è¯•æ‰‹æ°”å§ï¼
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŠ•ç¥¨ç¦ç­¾éƒ¨åˆ† -->
        <div class="section">
            <div class="section-title">
                <i class="layui-icon layui-icon-flag"></i> æŠ•ç¥¨ç¦ç­¾
            </div>
            <div class="vote-status-card">
                <div class="vote-status-title">æ‚¨çš„æŠ•ç¥¨çŠ¶æ€</div>
                <div class="vote-cards" id="voteStatusCards">
                    <!-- æŠ•ç¥¨çŠ¶æ€å¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
                </div>
            </div>

            <div class="section-title" style="margin-top: 30px;">
                <i class="layui-icon layui-icon-trophy"></i> æŠ•ç¥¨æ’è¡Œæ¦œ
            </div>

            <!-- æ‹†åˆ†ä¸ºä¸‰ä¸ªå•é¡¹æ¦œå• -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- äº‹ä¸šç¬¦æ’è¡Œæ¦œ -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">ğŸ’¼</span> äº‹ä¸šç¬¦æ’è¡Œæ¦œ
                    </h3>
                    <div id="careerRankList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</div>
                    </div>
                </div>

                <!-- å§»ç¼˜ç¬¦æ’è¡Œæ¦œ -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">ğŸ’•</span> å§»ç¼˜ç¬¦æ’è¡Œæ¦œ
                    </h3>
                    <div id="romanceRankList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</div>
                    </div>
                </div>

                <!-- æ‹›è´¢ç¬¦æ’è¡Œæ¦œ -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">ğŸ’°</span> æ‹›è´¢ç¬¦æ’è¡Œæ¦œ
                    </h3>
                    <div id="wealthRankList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="text-align: center; color: #999; padding: 20px;">æš‚æ— æ•°æ®</div>
                    </div>
                </div>
            </div>

            <div class="section-title" style="margin-top: 30px;">
                <i class="layui-icon layui-icon-history"></i> æˆ‘çš„æŠ•ç¥¨è®°å½•
            </div>
            <div id="myVoteRecords" style="color: #999; padding: 10px;">
                <!-- ç”¨æˆ·æŠ•ç¥¨è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€æ’å…¥ -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/layui.js"></script>
    <script>
        layui.use(['table', 'layer'], function(){
            var table = layui.table;
            var layer = layui.layer;

            // å…¨å±€ç”¨æˆ·ä¿¡æ¯
            let currentUserInfo = null;

            // æ£€æŸ¥Cookieä¸­çš„token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) {
                    const token = parts.pop().split(';').shift();
                    console.log('è·å–åˆ°çš„token:', token ? 'å­˜åœ¨' : 'ä¸å­˜åœ¨');
                    return token;
                }
                console.log('Cookieä¸­æœªæ‰¾åˆ°token');
                return null;
            }

            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
            async function checkLoginStatus() {
                const token = getCookie('token');
                console.log('å¼€å§‹æ£€æŸ¥ç™»å½•çŠ¶æ€, token:', token ? 'å·²è·å–' : 'æœªè·å–');

                if (!token) {
                    console.log('æœªæ‰¾åˆ°tokenï¼Œåˆ¤æ–­ä¸ºæœªç™»å½•');
                    return false;
                }

                try {
                    console.log('æ­£åœ¨è¯·æ±‚ /user/me æ¥å£...');
                    const response = await fetch('/user/me', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include' // ç¡®ä¿æºå¸¦cookie
                    });

                    console.log('APIå“åº”çŠ¶æ€:', response.status, response.statusText);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('è·å–åˆ°ç”¨æˆ·ä¿¡æ¯:', data);
                        currentUserInfo = {
                            id: data.id,
                            articleId: data.article_id,
                            articleOId: data.article_o_id,
                            articleThankCnt: data.article_thank_cnt || 0,
                            articleTitle: data.article_title || '',
                            avatar: data.avatar,
                            defaultTimes: data.default_mooncake_gambling_times || 0,
                            drawTimes: data.draw_times || 0,
                            name: data.name,
                            nickname: data.nickname,
                            oId: data.o_id,
                            restTimes: data.rest_times || 0
                        };
                        console.log('ç”¨æˆ·ä¿¡æ¯å·²ä¿å­˜:', currentUserInfo);
                        return true;
                    } else {
                        const errorText = await response.text();
                        console.error('APIè¯·æ±‚å¤±è´¥:', response.status, errorText);
                        return false;
                    }
                } catch (error) {
                    console.error('æ£€æŸ¥ç™»å½•çŠ¶æ€å¤±è´¥:', error);
                    return false;
                }
            }

            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ˜¾ç¤º
            function updateUserStatusDisplay() {
                const userStatusSection = document.getElementById('userStatusSection');
                const userStatusDice = document.getElementById('userStatusDice');

                if (!currentUserInfo) {
                    // æœªç™»å½•çŠ¶æ€
                    userStatusSection.innerHTML = `
                        <div class="login-prompt">
                            <div class="login-prompt-text">
                                ğŸ‰ æ‚¨å¥½ï¼Œæ¬¢è¿æ¥åˆ°ç¦åˆ©æ´»åŠ¨ï¼è¯·å…ˆç™»å½•æ‚¨çš„è´¦å·å‚ä¸åšé¥¼æŠ½å¥–ã€‚
                            </div>
                            <div>
                                <a href="/fishpi/login" class="layui-btn layui-btn-normal layui-btn-lg">
                                    <i class="layui-icon layui-icon-user"></i> ç«‹å³ç™»å½•
                                </a>
                            </div>
                        </div>
                    `;

                    // æ¸…ç©ºåšé¥¼åŒºåŸŸçš„ç”¨æˆ·ä¿¡æ¯
                    userStatusDice.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 20px;">
                            è¯·ç™»å½•åæŸ¥çœ‹æ‚¨çš„ä¿¡æ¯å’Œå‚ä¸åšé¥¼æŠ½å¥–
                        </div>
                    `;
                    return;
                }

                // å·²ç™»å½•çŠ¶æ€ - è®¡ç®—æ€»æ¬¡æ•°
                const totalTimes = currentUserInfo.defaultTimes + currentUserInfo.articleThankCnt;

                userStatusSection.innerHTML = `
                    <div class="user-card">
                        <div class="user-info">
                            <a href="${currentUserInfo.name ? ('https://fishpi.cn/member/' + encodeURIComponent(currentUserInfo.name)) : '/user/me'}" target="_blank" style="display:inline-flex; align-items:center; gap:12px; text-decoration:none; color:inherit;">
                                <img src="${currentUserInfo.avatar}" alt="avatar" class="user-avatar" onerror="this.src='https://file.fishpi.cn/default-avatar.png'">
                                <div class="user-details">
                                    <div class="user-nickname">${currentUserInfo.nickname || currentUserInfo.name}</div>
                                    <div class="user-name">@${currentUserInfo.name}</div>
                                    ${currentUserInfo.articleTitle ? `<div style="font-size: 12px; color: #1E9FFF; margin-top: 3px;"><a href=\"https://fishpi.cn/article/${currentUserInfo.articleOId}\" target=\"_blank\" style=\"color:#1E9FFF; text-decoration:none;\">ğŸ“ ${currentUserInfo.articleTitle}</a></div>` : ''}
                                </div>
                            </a>
                        </div>
                        <div class="times-info">
                            <div class="times-item">
                                <span>æ€»æ¬¡æ•°ï¼š</span>
                                <span class="times-number">${totalTimes}</span>
                                <span style="font-size: 12px; opacity: 0.8;">(é»˜è®¤${currentUserInfo.defaultTimes} + æ–‡ç« æ„Ÿè°¢${currentUserInfo.articleThankCnt})</span>
                            </div>
                            <div class="times-item">
                                <span>å‰©ä½™æ¬¡æ•°ï¼š</span>
                                <span class="times-number" style="color: #FFD700;">${currentUserInfo.restTimes}</span>
                            </div>
                            <div class="times-item" style="font-size: 12px; opacity: 0.9;">
                                <span>å·²ä½¿ç”¨ï¼š${totalTimes - currentUserInfo.restTimes} æ¬¡</span>
                            </div>
                        </div>
                    </div>
                `;

                // æ›´æ–°åšé¥¼åŒºåŸŸçš„ç”¨æˆ·ä¿¡æ¯
                userStatusDice.innerHTML = `
                    <div class="dice-user-info">
                        <a href="${currentUserInfo.name ? ('https://fishpi.cn/member/' + encodeURIComponent(currentUserInfo.name)) : '/user/me'}" target="_blank" style="display:flex; align-items:center; gap:20px; text-decoration:none; color:inherit;">
                            <img src="${currentUserInfo.avatar}" alt="avatar" class="dice-user-avatar" onerror="this.src='https://file.fishpi.cn/default-avatar.png'">
                            <div class="dice-user-details">
                                <div class="dice-user-nickname">${currentUserInfo.nickname || currentUserInfo.name}</div>
                                <div class="dice-user-name">@${currentUserInfo.name}</div>
                            </div>
                        </a>
                        <div class="dice-times-info">
                            <div class="dice-times-item">
                                <div class="dice-times-label">æ€»æ¬¡æ•°</div>
                                <div class="dice-times-number">${totalTimes}</div>
                            </div>
                            <div class="dice-times-item">
                                <div class="dice-times-label">å‰©ä½™æ¬¡æ•°</div>
                                <div class="dice-times-number remaining">${currentUserInfo.restTimes}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // æ£€æŸ¥ URL å‚æ•°
            function checkURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const from = urlParams.get('from');

                if(from === 'login') {
                    // æ˜¾ç¤ºç™»å½•æˆåŠŸæç¤º
                    layer.msg('ç™»å½•æˆåŠŸ', {icon: 1, time: 2000});
                } else if(from === 'register') {
                    // æ˜¾ç¤ºæ³¨å†Œæç¤ºå¼¹çª—
                    layer.open({
                        type: 1,
                        title: 'æ¬¢è¿å‚ä¸æ´»åŠ¨',
                        area: ['450px', '280px'],
                        content: `
                            <div style="padding: 20px; text-align: center;">
                                <div style="font-size: 16px; color: #333; margin-bottom: 30px; line-height: 1.6;">
                                    å‘è¡¨æ–‡ç« åï¼Œæ‰èƒ½å‚ä¸åšé¥¼æ´»åŠ¨
                                </div>
                                <div style="display: flex; gap: 15px; justify-content: center;">
                                    <a href="https://fishpi.cn/article/1759997269582" target="_blank" class="layui-btn layui-btn-primary layui-btn-lg">
                                        <i class="layui-icon layui-icon-read"></i> æŸ¥çœ‹åŸæ–‡
                                    </a>
                                    <a href="https://fishpi.cn/post?type=0&tags=ç¦ç­¾ä¼ æƒ…&title=ã€åŒèŠ‚åŒåº†ã€‘æˆ‘çš„æ•…äº‹" target="_blank" class="layui-btn layui-btn-normal layui-btn-lg">
                                        <i class="layui-icon layui-icon-edit"></i> å‘è¡¨æ–‡ç« 
                                    </a>
                                </div>
                            </div>
                        `,
                        shadeClose: true,
                        btn: false
                    });
                }
            }

            // é¡µé¢åˆå§‹åŒ–
            async function initPage() {
                // æ£€æŸ¥ç™»å½•çŠ¶æ€
                const isLoggedIn = await checkLoginStatus();

                // æ›´æ–°ç”¨æˆ·çŠ¶æ€æ˜¾ç¤º
                updateUserStatusDisplay();

                // å¦‚æœå·²ç™»å½•ï¼ŒåŠ è½½å†å²è®°å½•
                if (isLoggedIn) {
                    await loadHistoryFromServer();
                }

                // æ£€æŸ¥URLå‚æ•°
                checkURLParams();

                // åŠ è½½å¥–åŠ±æ•°æ®
                loadRewards();

                // æ¸²æŸ“æ–‡ç« æ’è¡Œæ¦œ
                renderArticleTable();

                // åŠ è½½æŠ•ç¥¨çŠ¶æ€
                if (isLoggedIn) {
                    await loadVoteStatus();
                }
            }

            // å…¨å±€å¥–åŠ±æ•°æ®
            let rewardsData = [];

            // åŠ è½½å¥–åŠ±åˆ—è¡¨
            function loadRewards() {
                fetch('/api/collections/rewards/records?expand=awards_via_rewardId&sort=-level')
                    .then(response => response.json())
                    .then(data => {
                        if(data.items && data.items.length > 0) {
                            rewardsData = data.items;
                            renderRewardsList();
                        }
                    })
                    .catch(error => {
                        console.error('åŠ è½½å¥–åŠ±åˆ—è¡¨å¤±è´¥:', error);
                        layer.msg('å¥–åŠ±åˆ—è¡¨åŠ è½½å¤±è´¥', {icon: 2});
                    });
            }

            // æ¸²æŸ“å¥–åŠ±åˆ—è¡¨
            function renderRewardsList() {
                const prizeTableBody = document.querySelector('.prize-table tbody');
                if(!prizeTableBody) return;

                prizeTableBody.innerHTML = '';

                if(rewardsData.length === 0) {
                    prizeTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">æš‚æ— å¥–åŠ±æ•°æ®</td></tr>';
                    return;
                }

                rewardsData.forEach(reward => {
                    const awards = reward.expand && reward.expand.awards_via_rewardId ? reward.expand.awards_via_rewardId : [];
                    awards.sort((a, b) => (b.level || 0) - (a.level || 0));

                    if(awards.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="font-weight: bold; color: #FF5722; font-size: 16px; text-align: center; vertical-align: middle;">${reward.name}</td>
                            <td style="color: #999; text-align: center;">-</td>
                            <td style="color: #999; text-align: center;">-</td>
                            <td style="font-weight: 500; color: #1E9FFF; text-align: center;">${reward.point || 0}</td>
                            <td style="color: #999; text-align: center;">${reward.amount || '-'}</td>
                            <td style="color: #999; text-align: center; font-size: 12px;">${reward.more || '-'}</td>
                        `;
                        prizeTableBody.appendChild(row);
                        return;
                    }

                    awards.forEach((award, index) => {
                        const row = document.createElement('tr');

                        if(index === 0) {
                            const rewardCell = document.createElement('td');
                            rewardCell.rowSpan = awards.length;
                            rewardCell.style.cssText = 'font-weight: bold; color: #FF5722; font-size: 16px; text-align: center; vertical-align: middle; border-right: 2px solid #eee;';
                            rewardCell.textContent = reward.name;
                            row.appendChild(rewardCell);
                        }

                        const nameCell = document.createElement('td');
                        nameCell.style.cssText = 'font-weight: bold; color: #1E9FFF;';
                        nameCell.textContent = award.name || '-';
                        row.appendChild(nameCell);

                        const descCell = document.createElement('td');
                        descCell.style.cssText = 'font-size: 12px; color: #666;';
                        descCell.textContent = award.description || '-';
                        row.appendChild(descCell);

                        if(index === 0) {
                            const pointCell = document.createElement('td');
                            pointCell.rowSpan = awards.length;
                            pointCell.style.cssText = 'font-weight: 500; color: #1E9FFF; text-align: center; vertical-align: middle; font-size: 16px;';
                            pointCell.textContent = reward.point || 0;
                            row.appendChild(pointCell);

                            const amountCell = document.createElement('td');
                            amountCell.rowSpan = awards.length;
                            amountCell.style.cssText = 'font-weight: 500; color: #666; text-align: center; vertical-align: middle;';
                            amountCell.textContent = reward.amount || '-';
                            row.appendChild(amountCell);

                            const moreCell = document.createElement('td');
                            moreCell.rowSpan = awards.length;
                            moreCell.style.cssText = 'color: #999; text-align: left; vertical-align: middle; font-size: 12px;';
                            moreCell.textContent = reward.more || '-';
                            row.appendChild(moreCell);
                        }

                        prizeTableBody.appendChild(row);
                    });
                });
            }

            // æ–‡ç« æ’è¡Œæ¦œè¡¨æ ¼
            function renderArticleTable() {
                table.render({
                    elem: '#articleTable',
                    url: '/api/collections/articles/records?expand=userId&sort=-createdAt',
                    height: 500,
                    page: true,
                    limit: 10,
                    limits: [10, 20, 50, 100],
                    cols: [[
                        {field: 'title', title: 'æ–‡ç« æ ‡é¢˜', width: 350, templet: function(d){
                            return '<a href="https://fishpi.cn/article/' + d.oId + '" target="_blank" style="color: #1E9FFF; text-decoration: none;">' + d.title + '</a>';
                        }},
                        {field: 'expand', title: 'ä½œè€…', width: 200, templet: function(d){
                            if(d.expand && d.expand.userId) {
                                const user = d.expand.userId;
                                const displayName = user.nickname || user.name || '-';
                                const memberName = user.name || '';
                                const avatar = user.avatar || '';
                                const avatarHtml = '<img src="' + avatar + '" alt="avatar" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;" onerror="this.src=\'https://file.fishpi.cn/default-avatar.png\'" />';
                                if(memberName) {
                                    const memberUrl = 'https://fishpi.cn/member/' + encodeURIComponent(memberName);
                                    return '<a href="' + memberUrl + '" target="_blank" style="display: flex; align-items: center; gap: 8px; color: inherit; text-decoration: none;">' +
                                           avatarHtml +
                                           '<span>' + displayName + '</span>' +
                                           '</a>';
                                }
                                return '<div style="display: flex; align-items: center; gap: 8px;">' + avatarHtml + '<span>' + displayName + '</span></div>';
                            }
                            return '-';
                        }},
                        {field: 'viewCount', title: 'æµè§ˆé‡', width: 100, sort: true},
                        {field: 'goodCnt', title: 'ç‚¹èµé‡', width: 100, sort: true},
                        {field: 'commentCount', title: 'è¯„è®ºæ•°', width: 100, sort: true},
                        {field: 'collectCnt', title: 'æ”¶è—é‡', width: 100, sort: true},
                        {field: 'thankCnt', title: 'æ„Ÿè°¢æ•°', width: 100, sort: true},
                        {field: 'created', title: 'åˆ›å»ºæ—¶é—´', width: 180, sort: true, templet: function(d){
                            return formatDate(d.createdAt || d.created);
                         }},
                         {field: 'updated', title: 'æ›´æ–°æ—¶é—´', width: 180, sort: true, templet: function(d){
                            return formatDate(d.updatedAt || d.updated);
                         }}
                    ]],
                    parseData: function(res){
                        return {
                            "code": 0,
                            "msg": "",
                            "count": res.totalItems,
                            "data": res.items
                        };
                    },
                    done: function(res, curr, count){
                        // é«˜äº®å½“å‰ç”¨æˆ·çš„æ–‡ç« 
                        if(currentUserInfo && currentUserInfo.articleId) {
                            res.data.forEach((item, index) => {
                                if(item.id === currentUserInfo.articleId) {
                                    const row = document.querySelector(`#articleTable + .layui-table-view .layui-table-body tr[data-index="${index}"]`);
                                    if(row) {
                                        row.classList.add('my-article-row');
                                    }
                                }
                            });
                        }
                    }
                });
            }

            // åšé¥¼æ¸¸æˆé€»è¾‘
            let isRolling = false;
            let history = [];

            // é¡µé¢åŠ è½½æ—¶è·å–å†å²è®°å½•
            async function loadHistoryFromServer() {
                if (!currentUserInfo) return;

                try {
                    const response = await fetch('/mooncake/history', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('è·å–åˆ°å†å²è®°å½•:', data);

                        // è½¬æ¢æœåŠ¡å™¨æ•°æ®ä¸ºå‰ç«¯æ ¼å¼
                        history = data.items.map(item => ({
                            time: formatDate(item.created),
                            result: {
                                dices: item.dices,
                                awardName: item.award_name,
                                prizeName: item.prize_name,
                                prizeLevel: item.prize_level
                            }
                        }));

                        updateHistoryDisplay();
                    }
                } catch (error) {
                    console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', error);
                }
            }

            document.getElementById('rollBtn').addEventListener('click', async function(){
                if(isRolling) return;

                // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ç™»å½•
                if(!currentUserInfo) {
                    layer.confirm('æ‚¨è¿˜æœªç™»å½•ï¼Œæ˜¯å¦å‰å¾€ç™»å½•ï¼Ÿ', {
                        icon: 3,
                        title: 'æç¤º',
                        btn: ['å»ç™»å½•', 'å–æ¶ˆ']
                    }, function(index){
                        window.location.href = '/fishpi/login';
                        layer.close(index);
                    });
                    return;
                }

                // æ£€æŸ¥ç”¨æˆ·å‰©ä½™åšé¥¼æ¬¡æ•°
                if(currentUserInfo.restTimes <= 0) {
                    layer.msg('æ‚¨çš„åšé¥¼æ¬¡æ•°å·²ç”¨å®Œï¼Œè¯·æ˜å¤©å†æ¥å§ï¼', {icon: 2, time: 2000});
                    return;
                }

                isRolling = true;
                const rollButton = document.getElementById('rollBtn');
                rollButton.disabled = true;

                try {
                    // è°ƒç”¨æœåŠ¡å™¨åšé¥¼æ¥å£
                    console.log('æ­£åœ¨è°ƒç”¨åšé¥¼æ¥å£...');
                    const response = await fetch('/mooncake/gambling', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if(!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || 'åšé¥¼è¯·æ±‚å¤±è´¥');
                    }

                    const result = await response.json();
                    console.log('åšé¥¼ç»“æœ:', result);

                    // æ˜¾ç¤ºéª°å­åŠ¨ç”»
                    const dices = document.querySelectorAll('.dice');
                    dices.forEach(dice => {
                        dice.textContent = '?';
                        dice.classList.add('rolling');
                    });

                    // 1ç§’åä¾æ¬¡æ˜¾ç¤ºç»“æœ
                    setTimeout(() => {
                        let completedCount = 0;

                        dices.forEach((dice, index) => {
                            setTimeout(() => {
                                dice.classList.remove('rolling');
                                dice.innerHTML = `<img src="data:image/svg+xml;base64,${getDiceSVGBase64(result.dices[index])}" alt="dice-${result.dices[index]}" style="width: 60px; height: 60px;" />`;

                                completedCount++;

                                if(completedCount === 6) {
                                    // æ›´æ–°å‰©ä½™æ¬¡æ•°
                                    currentUserInfo.restTimes = result.rest_times;
                                    updateUserStatusDisplay();

                                    // æ·»åŠ åˆ°å†å²è®°å½•ï¼ˆå‰ç«¯æ˜¾ç¤ºï¼‰
                                    addHistory({
                                        dices: result.dices,
                                        awardName: result.award_name,
                                        prizeName: result.prize_name,
                                        prizeLevel: result.prize_level
                                    });

                                    isRolling = false;
                                    rollButton.disabled = false;

                                    // æ˜¾ç¤ºæç¤ºï¼ˆåŒ…å«å¥–é¡¹åç§°ï¼‰
                                    setTimeout(() => {
                                        let message = 'ç§‘è€ƒç»“æœï¼š' + result.award_name;
                                        if (result.reward_name) {
                                            message += ' - ' + result.reward_name;
                                        }
                                        layer.msg(message, {icon: 1, time: 3000});
                                    }, 200);
                                }
                            }, index * 200);
                        });
                    }, 1000);

                } catch(error) {
                    console.error('åšé¥¼å¤±è´¥:', error);
                    layer.msg(error.message || 'åšé¥¼å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                    isRolling = false;
                    rollButton.disabled = false;
                }
            });

            // æ·»åŠ å†å²è®°å½•
            function addHistory(result) {
                const now = new Date();
                history.unshift({
                    time: formatDate(now),
                    result: result
                });

                if(history.length > 20) {
                    history = history.slice(0, 20);
                }

                updateHistoryDisplay();
            }

            // æ›´æ–°å†å²è®°å½•æ˜¾ç¤º
            function updateHistoryDisplay() {
                const historyList = document.getElementById('historyList');
                if(history.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">æš‚æ— è®°å½•ï¼Œå¿«æ¥è¯•è¯•æ‰‹æ°”å§ï¼</div>';
                    return;
                }

                historyList.innerHTML = history.map(h => `
                    <div class="history-item">
                        <div class="history-time">${h.time}</div>
                        <div class="history-result">${h.result.awardName} - ${h.result.prizeName}</div>
                        <div class="history-dices" style="display: flex; align-items: center; gap: 3px;">
                            ${h.result.dices.map(d => `<img src="data:image/svg+xml;base64,${getDiceSVGBase64(d)}" alt="dice-${d}" class="dice-svg" />`).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // æ ¼å¼åŒ–æ—¥æœŸ
            function formatDate(date) {
                if(!date) return '-';
                try {
                    if(typeof date === 'string') {
                        let s = date.trim();
                        if(s.indexOf('T') === -1 && s.indexOf(' ') !== -1) {
                            s = s.replace(' ', 'T');
                        }
                        date = new Date(s);
                    }

                    if(!(date instanceof Date) || isNaN(date.getTime())) return '-';

                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    const second = String(date.getSeconds()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) {
                    return '-';
                }
             }

            // è·å–éª°å­SVGçš„Base64ç¼–ç 
            function getDiceSVGBase64(d) {
                const svgs = {
                    1: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="50" cy="50" r="8" fill="red"/></svg>`,
                    2: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="#333"/><circle cx="70" cy="70" r="8" fill="#333"/></svg>`,
                    3: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="#333"/><circle cx="50" cy="50" r="8" fill="#333"/><circle cx="70" cy="70" r="8" fill="#333"/></svg>`,
                    4: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="red"/><circle cx="70" cy="30" r="8" fill="red"/><circle cx="30" cy="70" r="8" fill="red"/><circle cx="70" cy="70" r="8" fill="red"/></svg>`,
                    5: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="#333"/><circle cx="70" cy="30" r="8" fill="#333"/><circle cx="50" cy="50" r="8" fill="#333"/><circle cx="30" cy="70" r="8" fill="#333"/><circle cx="70" cy="70" r="8" fill="#333"/></svg>`,
                    6: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="25" r="8" fill="#333"/><circle cx="70" cy="25" r="8" fill="#333"/><circle cx="30" cy="50" r="8" fill="#333"/><circle cx="70" cy="50" r="8" fill="#333"/><circle cx="30" cy="75" r="8" fill="#333"/><circle cx="70" cy="75" r="8" fill="#333"/></svg>`
                };

                return btoa(unescape(encodeURIComponent(svgs[d])));
            }

            // åŠ è½½æŠ•ç¥¨çŠ¶æ€
            async function loadVoteStatus() {
                const voteStatusCards = document.getElementById('voteStatusCards');

                if (!currentUserInfo) {
                    voteStatusCards.innerHTML = '<div style="color: white; text-align: center; width: 100%;">è¯·ç™»å½•åæŸ¥çœ‹æ‚¨çš„æŠ•ç¥¨çŠ¶æ€</div>';
                    return;
                }

                try {
                    const response = await fetch('/vote/statistics', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('æŠ•ç¥¨ç»Ÿè®¡:', data);

                        const voteTypes = [
                            { type: 'career', name: 'äº‹ä¸šç¬¦', icon: 'ğŸ’¼', voted: data.career_voted },
                            { type: 'romance', name: 'å§»ç¼˜ç¬¦', icon: 'ğŸ’•', voted: data.romance_voted },
                            { type: 'wealth', name: 'æ‹›è´¢ç¬¦', icon: 'ğŸ’°', voted: data.wealth_voted }
                        ];

                        voteStatusCards.innerHTML = voteTypes.map(vt => `
                            <div class="vote-card ${vt.voted ? 'voted' : ''}" data-vote-type="${vt.type}">
                                <div class="vote-card-icon">${vt.icon}</div>
                                <div class="vote-card-name">${vt.name}</div>
                                <div class="vote-card-status">${vt.voted ? 'å·²èµ é€' : 'å¯èµ é€'}</div>
                            </div>
                        `).join('');

                        // ä¸ºæœªæŠ•ç¥¨çš„å¡ç‰‡æ·»åŠ ç‚¹å‡»äº‹ä»¶
                        voteTypes.forEach(vt => {
                            if (!vt.voted) {
                                const card = document.querySelector(`.vote-card[data-vote-type="${vt.type}"]`);
                                if (card) {
                                    card.style.cursor = 'pointer';
                                    card.addEventListener('click', () => showVoteDialog(vt.type, vt.name));
                                }
                            }
                        });
                    }

                    // åŠ è½½æ’è¡Œæ¦œå’Œä¸ªäººè®°å½•
                    await loadVoteRank();
                    await loadMyVotes();

                } catch (error) {
                    console.error('åŠ è½½æŠ•ç¥¨çŠ¶æ€å¤±è´¥:', error);
                    voteStatusCards.innerHTML = '<div style="color: white; text-align: center; width: 100%;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                }
            }

            // æ˜¾ç¤ºæŠ•ç¥¨å¯¹è¯æ¡†
            function showVoteDialog(voteType, voteName) {
                if (!currentUserInfo) {
                    layer.msg('è¯·å…ˆç™»å½•', {icon: 2});
                    return;
                }

                // è·å–æ‰€æœ‰æ–‡ç« åˆ—è¡¨
                fetch('/api/collections/articles/records?expand=userId&sort=-createdAt&perPage=100')
                    .then(response => response.json())
                    .then(data => {
                        const articles = data.items || [];

                        if (articles.length === 0) {
                            layer.msg('æš‚æ— æ–‡ç« å¯ä¾›æŠ•ç¥¨', {icon: 2});
                            return;
                        }

                        // æ„å»ºæ–‡ç« é€‰æ‹©åˆ—è¡¨ï¼Œä¿ç•™è‡ªå·±çš„æ–‡ç« ä½†æ·»åŠ è’™ç‰ˆ
                        const articleListHtml = articles.map((article, index) => {
                            const user = article.expand && article.expand.userId ? article.expand.userId : {};
                            const displayName = user.nickname || user.name || 'æœªçŸ¥ç”¨æˆ·';
                            const isMyArticle = article.userId === currentUserInfo.id;

                            // è‡ªå·±çš„æ–‡ç« æ·»åŠ è’™ç‰ˆæ ·å¼
                            if (isMyArticle) {
                                return `
                                    <div class="article-select-item" style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; position: relative; opacity: 0.5; cursor: not-allowed;">
                                        <a href="https://fishpi.cn/article/${article.oId}" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center; gap:8px; text-decoration:none; color:inherit;">
                                            <img src="${user.avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                                        </a>
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #999;"><a href="https://fishpi.cn/article/${article.oId}" target="_blank" onclick="event.stopPropagation()" style="color: #999; text-decoration: none;">${article.title}</a></div>
                                            <div style="font-size: 12px; color: #bbb;">ä½œè€…: <a href="${user.name ? ('https://fishpi.cn/member/' + encodeURIComponent(user.name)) : '#'}" target="_blank" onclick="event.stopPropagation()" style="color:#bbb; text-decoration:none;">${displayName}</a></div>
                                        </div>
                                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.85); display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                            <div style="background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; box-shadow: 0 2px 8px rgba(255, 184, 0, 0.3);">
                                                <i style="margin-right: 5px;">âœ‹</i> æ¸©é¦¨æç¤ºï¼šæŠŠæœºä¼šç•™ç»™å…¶ä»–ä½œè€…å§~
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }

                            // å…¶ä»–äººçš„æ–‡ç« æ­£å¸¸æ˜¾ç¤º
                            return `
                                <div class="article-select-item" data-article-id="${article.id}" data-article-title="${article.title.replace(/\"/g, '&quot;')}" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                    <a href="https://fishpi.cn/article/${article.oId}" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:inherit;">
                                        <img src="${user.avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #333;">${article.title}</div>
                                            <div style="font-size: 12px; color: #999;">ä½œè€…: <a href="${user.name ? ('https://fishpi.cn/member/' + encodeURIComponent(user.name)) : '#'}" target="_blank" onclick="event.stopPropagation()" style="color:#1E9FFF; text-decoration:none;">${displayName}</a></div>
                                        </div>
                                    </a>
                                </div>
                            `;
                        }).join('');

                        layer.open({
                            type: 1,
                            title: `èµ é€${voteName}`,
                            area: ['600px', '500px'],
                            content: `
                                <div style="padding: 20px;">
                                    <div style="margin-bottom: 15px; color: #666;">
                                        é€‰æ‹©ä¸€ç¯‡æ–‡ç« èµ é€${voteName}
                                    </div>
                                    <div id="articleSelectList" style="max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
                                        ${articleListHtml}
                                    </div>
                                </div>
                            `,
                            success: function(layero, index) {
                                // ä½¿ç”¨åŸç”ŸJavaScriptæ·»åŠ äº‹ä»¶
                                const container = document.getElementById('articleSelectList');
                                if (!container) return;

                                const items = container.querySelectorAll('.article-select-item[data-article-id]');
                                items.forEach(item => {
                                    // ç‚¹å‡»äº‹ä»¶
                                    item.addEventListener('click', function() {
                                        const articleId = this.getAttribute('data-article-id');
                                        const articleTitle = this.getAttribute('data-article-title');

                                        layer.confirm(`ç¡®è®¤è¦å°†${voteName}èµ é€ç»™è¿™ç¯‡æ–‡ç« å—ï¼Ÿ<br><br>"${articleTitle}"`, {
                                            icon: 3,
                                            title: 'ç¡®è®¤èµ é€',
                                            btn: ['ç¡®è®¤', 'å–æ¶ˆ']
                                        }, function(confirmIndex) {
                                            submitVote(articleId, voteType, voteName);
                                            layer.close(confirmIndex);
                                            layer.close(index);
                                        });
                                    });

                                    // æ‚¬åœæ•ˆæœ
                                    item.addEventListener('mouseenter', function() {
                                        this.style.background = '#f8f9fa';
                                    });
                                    item.addEventListener('mouseleave', function() {
                                        this.style.background = 'white';
                                    });
                                });
                            }
                        });
                    })
                    .catch(error => {
                        console.error('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥:', error);
                        layer.msg('åŠ è½½æ–‡ç« åˆ—è¡¨å¤±è´¥', {icon: 2});
                    });
            }

            // æäº¤æŠ•ç¥¨
            async function submitVote(articleId, voteType, voteName) {
                try {
                    const response = await fetch('/vote', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            article_id: articleId,
                            vote_type: voteType
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        layer.msg(`${voteName}èµ é€æˆåŠŸï¼`, {icon: 1, time: 2000});

                        // åˆ·æ–°æŠ•ç¥¨çŠ¶æ€
                        await loadVoteStatus();
                    } else {
                        const error = await response.json();
                        layer.msg(error.message || 'èµ é€å¤±è´¥', {icon: 2});
                    }
                } catch (error) {
                    console.error('æŠ•ç¥¨å¤±è´¥:', error);
                    layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                }
            }

            // æ’¤é”€æŠ•ç¥¨
            async function revokeVote(voteId, voteName) {
                layer.confirm(`ç¡®å®šè¦æ’¤é”€${voteName}çš„èµ é€å—ï¼Ÿ`, {
                    icon: 3,
                    title: 'ç¡®è®¤æ’¤é”€',
                    btn: ['ç¡®è®¤', 'å–æ¶ˆ']
                }, async function(index) {
                    try {
                        const response = await fetch(`/vote/${voteId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });

                        if (response.ok) {
                            layer.msg('æ’¤é”€æˆåŠŸï¼', {icon: 1, time: 2000});
                            await loadVoteStatus();
                        } else {
                            const error = await response.json();
                            layer.msg(error.message || 'æ’¤é”€å¤±è´¥', {icon: 2});
                        }
                    } catch (error) {
                        console.error('æ’¤é”€å¤±è´¥:', error);
                        layer.msg('ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•', {icon: 2});
                    }
                    layer.close(index);
                });
            }

            // å°†revokeVoteæš´éœ²åˆ°å…¨å±€ä½œç”¨åŸŸ
            window.revokeVote = revokeVote;

            // åŠ è½½æŠ•ç¥¨æ’è¡Œæ¦œ - æ‹†åˆ†ä¸ºä¸‰ä¸ªå•é¡¹æ¦œå•
            async function loadVoteRank() {
                try {
                    const response = await fetch('/vote/rank', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const items = data.items || [];

                        if (items.length === 0) {
                            renderEmptyRank('careerRankList');
                            renderEmptyRank('romanceRankList');
                            renderEmptyRank('wealthRankList');
                            return;
                        }

                        // æŒ‰äº‹ä¸šç¬¦ã€å§»ç¼˜ç¬¦ã€æ‹›è´¢ç¬¦åˆ†åˆ«æ’åºï¼Œå–å‰3å
                        const careerRank = [...items].sort((a, b) => b.career_count - a.career_count).filter(item => item.career_count > 0).slice(0, 3);
                        const romanceRank = [...items].sort((a, b) => b.romance_count - a.romance_count).filter(item => item.romance_count > 0).slice(0, 3);
                        const wealthRank = [...items].sort((a, b) => b.wealth_count - a.wealth_count).filter(item => item.wealth_count > 0).slice(0, 3);

                        renderRankList('careerRankList', careerRank, 'career', 'ğŸ’¼');
                        renderRankList('romanceRankList', romanceRank, 'romance', 'ğŸ’•');
                        renderRankList('wealthRankList', wealthRank, 'wealth', 'ğŸ’°');
                    }
                } catch (error) {
                    console.error('åŠ è½½æŠ•ç¥¨æ’è¡Œæ¦œå¤±è´¥:', error);
                    renderEmptyRank('careerRankList', 'åŠ è½½å¤±è´¥');
                    renderEmptyRank('romanceRankList', 'åŠ è½½å¤±è´¥');
                    renderEmptyRank('wealthRankList', 'åŠ è½½å¤±è´¥');
                }
            }

            // æ¸²æŸ“å•ä¸ªæ’è¡Œæ¦œ
            function renderRankList(containerId, items, type, icon) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (items.length === 0) {
                    renderEmptyRank(containerId);
                    return;
                }

                const countField = type + '_count';

                container.innerHTML = items.map((item, index) => {
                    const rank = index + 1;
                    let rankBadgeClass = 'rank-other';
                    if (rank === 1) rankBadgeClass = 'rank-1';
                    else if (rank === 2) rankBadgeClass = 'rank-2';
                    else if (rank === 3) rankBadgeClass = 'rank-3';

                    const memberHref = item.user_name ? ('https://fishpi.cn/member/' + encodeURIComponent(item.user_name)) : '#';

                    return `
                        <div style="background: white; border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                            <span class="rank-badge ${rankBadgeClass}" style="flex-shrink: 0;">${rank}</span>
                            <a href="${memberHref}" target="_blank" style="display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:inherit; flex-shrink:0;">
                                <img src="${item.user_avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                            </a>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; color: #333; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><a href="${memberHref}" target="_blank" style="color:inherit; text-decoration:none;">${item.user_nickname || item.user_name}</a></div>
                                <div style="font-size: 11px; color: #1E9FFF; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    <a href="https://fishpi.cn/article/${item.article_oid}" target="_blank" style="color: inherit; text-decoration: none;" title="${item.article_title}">${item.article_title}</a>
                                </div>
                            </div>
                            <div style="text-align: center; flex-shrink: 0;">
                                <div style="font-size: 20px; font-weight: bold; color: #FF5722;">${item[countField]}</div>
                                <div style="font-size: 11px; color: #999;">${icon} ç¥¨æ•°</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // æ¸²æŸ“ç©ºæ’è¡Œæ¦œ
            function renderEmptyRank(containerId, message = 'æš‚æ— æ•°æ®') {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">${message}</div>`;
            }

            // åŠ è½½æˆ‘çš„æŠ•ç¥¨è®°å½•
            async function loadMyVotes() {
                const myVoteRecords = document.getElementById('myVoteRecords');

                if (!currentUserInfo) {
                    myVoteRecords.innerHTML = '<div style="text-align: center; padding: 20px;">è¯·ç™»å½•åæŸ¥çœ‹æ‚¨çš„æŠ•ç¥¨è®°å½•</div>';
                    return;
                }

                try {
                    const response = await fetch('/vote/my', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const items = data.items || [];

                        if (items.length === 0) {
                            myVoteRecords.innerHTML = '<div style="text-align: center; padding: 20px;">æ‚¨è¿˜æ²¡æœ‰èµ é€è¿‡ç¦ç­¾</div>';
                            return;
                        }

                        const voteTypeMap = {
                            'career': { name: 'äº‹ä¸šç¬¦', icon: 'ğŸ’¼' },
                            'romance': { name: 'å§»ç¼˜ç¬¦', icon: 'ğŸ’•' },
                            'wealth': { name: 'æ‹›è´¢ç¬¦', icon: 'ğŸ’°' }
                        };

                        myVoteRecords.innerHTML = `
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                ${items.map(item => {
                                    const voteInfo = voteTypeMap[item.vote_type] || { name: 'æœªçŸ¥', icon: 'â“' };
                                    const memberHref = item.to_user_name ? ('https://fishpi.cn/member/' + encodeURIComponent(item.to_user_name)) : '#';
                                    return `
                                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; flex: 1; min-width: 250px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                                <span style="font-size: 24px;">${voteInfo.icon}</span>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold; color: #333;">${voteInfo.name}</div>
                                                    <div style="font-size: 11px; color: #999;">${formatDate(item.created)}</div>
                                                </div>
                                                <button class="layui-btn layui-btn-xs layui-btn-danger" onclick="revokeVote('${item.id}', '${voteInfo.name}')" style="position: absolute; top: 10px; right: 10px;">
                                                    <i class="layui-icon layui-icon-close"></i> æ’¤é”€
                                                </button>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                <a href="${memberHref}" target="_blank" style="display:inline-block;">
                                                    <img src="${item.to_user_avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                                                </a>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold; color: #333; font-size: 13px;"><a href="${memberHref}" target="_blank" style="color:inherit; text-decoration:none;">${item.to_user_nick || item.to_user_name}</a></div>
                                                    <div style="font-size: 11px; color: #1E9FFF;">
                                                        <a href="https://fishpi.cn/article/${item.article_oid}" target="_blank" style="color: inherit; text-decoration: none;" title="${item.article_title}">${item.article_title.substring(0, 25)}${item.article_title.length > 25 ? '...' : ''}</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('åŠ è½½æˆ‘çš„æŠ•ç¥¨è®°å½•å¤±è´¥:', error);
                    myVoteRecords.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56c6c;">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
                }
            }

            // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
            initPage();
        });
    </script>
</body>
</html>
