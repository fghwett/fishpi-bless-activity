<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>福利活动 - 文章排行榜 & 博饼抽奖</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/css/layui.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* 用户信息卡片样式 */
        .user-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 15px;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .user-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #1E9FFF;
        }
        .user-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        .user-nickname {
            font-size: 20px;
            font-weight: bold;
            color: #333;
        }
        .user-name {
            font-size: 14px;
            color: #999;
        }
        .times-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            color: white;
        }
        .times-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }
        .times-number {
            font-size: 20px;
            font-weight: bold;
        }
        .login-prompt {
            background: white;
            border-radius: 10px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            text-align: center;
        }
        .login-prompt-text {
            font-size: 18px;
            color: #666;
            margin-bottom: 20px;
        }

        .section {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #1E9FFF;
        }

        /* 博饼区域样式 */
        .mooncake-section {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .prize-panel {
            width: 100%;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-x: auto;
            overflow-y: auto;
            max-height: 400px;
            box-sizing: border-box;
        }
        .prize-table {
            width: 100%;
            min-width: 730px;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .prize-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .prize-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }
        .prize-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
            word-wrap: break-word;
            word-break: break-word;
        }
        .prize-table tbody tr:hover {
            background: #f8f9fa;
        }
        .prize-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* 高亮我的文章 */
        .my-article-row {
            background: #fff3cd !important;
            border-left: 4px solid #ffc107;
        }

        /* 福签投票样式 */
        .vote-status-card {
            background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%);
            border-radius: 10px;
            padding: 20px;
            color: white;
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }
        .vote-status-title {
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 15px;
            text-align: center;
        }
        .vote-cards {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }
        .vote-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 8px;
            padding: 15px;
            min-width: 120px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .vote-card-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }
        .vote-card-name {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }
        .vote-card-status {
            font-size: 12px;
            color: #666;
        }
        .vote-card.voted {
            opacity: 0.6;
            position: relative;
        }
        .vote-card.voted::after {
            content: '✓ 已赠送';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(30, 159, 255, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        /* 投票排行榜样式 */
        .vote-rank-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .vote-rank-table thead {
            background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%);
            color: white;
        }
        .vote-rank-table th {
            padding: 12px 10px;
            text-align: left;
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }
        .vote-rank-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
            font-size: 13px;
        }
        .vote-rank-table tbody tr:hover {
            background: #fff3cd;
        }
        .vote-rank-table tbody tr:last-child td {
            border-bottom: none;
        }
        .rank-badge {
            display: inline-block;
            width: 24px;
            height: 24px;
            line-height: 24px;
            text-align: center;
            border-radius: 50%;
            font-weight: bold;
            color: white;
        }
        .rank-1 { background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%); }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0 0%, #808080 100%); }
        .rank-3 { background: linear-gradient(135deg, #CD7F32 0%, #8B4513 100%); }
        .rank-other { background: #999; }

        .dice-area {
            width: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 30px 15px;
            position: relative;
            min-height: 400px;
            box-sizing: border-box;
            overflow: hidden;
        }

        /* 博饼区域内的用户信息样式 */
        .dice-user-info {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            flex-wrap: wrap;
            margin-bottom: 20px;
            padding: 15px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            width: 90%;
            max-width: 600px;
        }
        .dice-user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #1E9FFF;
        }
        .dice-user-details {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .dice-user-nickname {
            font-size: 18px;
            font-weight: bold;
            color: #333;
        }
        .dice-user-name {
            font-size: 12px;
            color: #999;
        }
        .dice-times-info {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        .dice-times-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }
        .dice-times-label {
            font-size: 12px;
            color: #666;
        }
        .dice-times-number {
            font-size: 24px;
            font-weight: bold;
            color: #1E9FFF;
        }
        .dice-times-number.remaining {
            color: #FFB800;
        }

        .dice-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 30px 0;
            max-width: 100%;
            flex-wrap: wrap;
        }
        .dice {
            width: 80px;
            height: 80px;
            background: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            color: #333;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: all 0.3s;
            box-sizing: border-box;
        }
        .dice.rolling {
            animation: roll 0.5s infinite;
        }
        @keyframes roll {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(90deg); }
            50% { transform: rotate(180deg); }
            75% { transform: rotate(270deg); }
        }
        .result-display {
            text-align: center;
            color: white;
            margin-top: 20px;
            max-width: 100%;
            padding: 0 10px;
            box-sizing: border-box;
        }
        .result-prize {
            font-size: 32px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        .result-level {
            font-size: 18px;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* SVG骰子样式 */
        .dice-svg-container {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin-top: 10px;
            flex-wrap: nowrap;
        }
        .dice-svg {
            width: 40px;
            height: 40px;
            opacity: 0;
            transform: scale(0.5);
            transition: all 0.3s ease-out;
        }
        .dice-svg.show {
            opacity: 1;
            transform: scale(1);
        }
        .history-dices .dice-svg {
            width: 24px;
            height: 24px;
            opacity: 1;
            transform: scale(1);
        }

        .history-panel {
            width: 100%;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            max-height: 400px;
            box-sizing: border-box;
        }
        .history-item {
            background: white;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 8px;
            font-size: 13px;
            border-left: 3px solid #FFB800;
            word-wrap: break-word;
            box-sizing: border-box;
        }
        .history-time {
            color: #999;
            font-size: 11px;
        }
        .history-result {
            color: #1E9FFF;
            font-weight: bold;
            margin: 5px 0;
        }
        .history-dices {
            color: #666;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 3px;
        }

        /* 响应式设计 */
        @media screen and (max-width: 768px) {
            .container {
                padding: 10px;
            }
            .section {
                padding: 15px;
            }
            .dice {
                width: 60px;
                height: 60px;
                font-size: 30px;
            }
            .dice-container {
                gap: 10px;
            }
            .dice-area {
                padding: 20px 10px;
                min-height: 350px;
            }
            .prize-table th,
            .prize-table td {
                padding: 8px 5px;
                font-size: 12px;
            }
            .user-card {
                flex-direction: column;
            }
        }

        @media screen and (max-width: 480px) {
            .dice {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            .result-prize {
                font-size: 24px !important;
            }
            .result-level {
                font-size: 14px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 用户信息卡片 / 登录提示 -->
        <div id="userStatusSection"></div>

        <!-- 文章排行榜部分 -->
        <div class="section">
            <div class="section-title">
                <i class="layui-icon layui-icon-chart"></i> 文章排行榜
            </div>
            <table class="layui-hide" id="articleTable" lay-filter="articleTable"></table>
        </div>

        <!-- 博饼抽奖部分 -->
        <div class="section">
            <div class="section-title">
                <i class="layui-icon layui-icon-gift"></i> 博饼抽奖
            </div>
            <div class="mooncake-section">
                <!-- 左侧：奖励列表 -->
                <div class="prize-panel">
                    <h3 style="margin-bottom: 15px; color: #333;">🎁 奖励列表</h3>
                    <table class="prize-table">
                        <thead>
                            <tr>
                                <th style="width: 100px;">奖励等级</th>
                                <th style="width: 120px;">奖项名称</th>
                                <th style="width: 200px;">奖项描述</th>
                                <th style="width: 80px;">积分</th>
                                <th style="width: 80px;">数量</th>
                                <th style="width: 150px;">备注</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td colspan="6" style="text-align: center; color: #999; padding: 20px;">
                                    暂无奖励可显示
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- 中间：博饼区域 -->
                <div class="dice-area">
                    <h2 style="color: white; margin-bottom: 20px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">
                        🎲 博饼游戏
                    </h2>

                    <!-- 用户信息显示 -->
                    <div class="dice-user-info" id="userStatusDice">
                        <!-- 用户信息内容将通过JavaScript动态插入 -->
                    </div>

                    <div class="dice-container">
                        <div class="dice" id="dice1">?</div>
                        <div class="dice" id="dice2">?</div>
                        <div class="dice" id="dice3">?</div>
                        <div class="dice" id="dice4">?</div>
                        <div class="dice" id="dice5">?</div>
                        <div class="dice" id="dice6">?</div>
                    </div>
                    <button class="layui-btn layui-btn-danger layui-btn-lg" id="rollBtn">
                        <i class="layui-icon layui-icon-play"></i> 开始博饼
                    </button>
                </div>

                <!-- 右侧：博饼记录 -->
                <div class="history-panel">
                    <h3 style="margin-bottom: 15px; color: #333;">📜 博饼记录</h3>
                    <div id="historyList">
                        <div style="text-align: center; color: #999; padding: 20px;">
                            暂无记录，快来试试手气吧！
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 投票福签部分 -->
        <div class="section">
            <div class="section-title">
                <i class="layui-icon layui-icon-flag"></i> 投票福签
            </div>
            <div class="vote-status-card">
                <div class="vote-status-title">您的投票状态</div>
                <div class="vote-cards" id="voteStatusCards">
                    <!-- 投票状态卡片将通过JavaScript动态插入 -->
                </div>
            </div>

            <div class="section-title" style="margin-top: 30px;">
                <i class="layui-icon layui-icon-trophy"></i> 投票排行榜
            </div>

            <!-- 拆分为三个单项榜单 -->
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px;">
                <!-- 事业符排行榜 -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">💼</span> 事业符排行榜
                    </h3>
                    <div id="careerRankList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="text-align: center; color: #999; padding: 20px;">暂无数据</div>
                    </div>
                </div>

                <!-- 姻缘符排行榜 -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">💕</span> 姻缘符排行榜
                    </h3>
                    <div id="romanceRankList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="text-align: center; color: #999; padding: 20px;">暂无数据</div>
                    </div>
                </div>

                <!-- 招财符排行榜 -->
                <div style="background: #f8f9fa; border-radius: 8px; padding: 15px;">
                    <h3 style="margin-bottom: 15px; color: #333; display: flex; align-items: center; gap: 8px;">
                        <span style="font-size: 24px;">💰</span> 招财符排行榜
                    </h3>
                    <div id="wealthRankList" style="display: flex; flex-direction: column; gap: 10px;">
                        <div style="text-align: center; color: #999; padding: 20px;">暂无数据</div>
                    </div>
                </div>
            </div>

            <div class="section-title" style="margin-top: 30px;">
                <i class="layui-icon layui-icon-history"></i> 我的投票记录
            </div>
            <div id="myVoteRecords" style="color: #999; padding: 10px;">
                <!-- 用户投票记录将通过JavaScript动态插入 -->
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/layui@2.8.18/dist/layui.js"></script>
    <script>
        layui.use(['table', 'layer'], function(){
            var table = layui.table;
            var layer = layui.layer;

            // 全局用户信息
            let currentUserInfo = null;

            // 检查Cookie中的token
            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) {
                    const token = parts.pop().split(';').shift();
                    console.log('获取到的token:', token ? '存在' : '不存在');
                    return token;
                }
                console.log('Cookie中未找到token');
                return null;
            }

            // 检查用户是否已登录
            async function checkLoginStatus() {
                const token = getCookie('token');
                console.log('开始检查登录状态, token:', token ? '已获取' : '未获取');

                if (!token) {
                    console.log('未找到token，判断为未登录');
                    return false;
                }

                try {
                    console.log('正在请求 /user/me 接口...');
                    const response = await fetch('/user/me', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include' // 确保携带cookie
                    });

                    console.log('API响应状态:', response.status, response.statusText);

                    if (response.ok) {
                        const data = await response.json();
                        console.log('获取到用户信息:', data);
                        currentUserInfo = {
                            id: data.id,
                            articleId: data.article_id,
                            articleOId: data.article_o_id,
                            articleThankCnt: data.article_thank_cnt || 0,
                            articleTitle: data.article_title || '',
                            avatar: data.avatar,
                            defaultTimes: data.default_mooncake_gambling_times || 0,
                            drawTimes: data.draw_times || 0,
                            name: data.name,
                            nickname: data.nickname,
                            oId: data.o_id,
                            restTimes: data.rest_times || 0
                        };
                        console.log('用户信息已保存:', currentUserInfo);
                        return true;
                    } else {
                        const errorText = await response.text();
                        console.error('API请求失败:', response.status, errorText);
                        return false;
                    }
                } catch (error) {
                    console.error('检查登录状态失败:', error);
                    return false;
                }
            }

            // 更新用户信息显示
            function updateUserStatusDisplay() {
                const userStatusSection = document.getElementById('userStatusSection');
                const userStatusDice = document.getElementById('userStatusDice');

                if (!currentUserInfo) {
                    // 未登录状态
                    userStatusSection.innerHTML = `
                        <div class="login-prompt">
                            <div class="login-prompt-text">
                                🎉 您好，欢迎来到福利活动！请先登录您的账号参与博饼抽奖。
                            </div>
                            <div>
                                <a href="/fishpi/login" class="layui-btn layui-btn-normal layui-btn-lg">
                                    <i class="layui-icon layui-icon-user"></i> 立即登录
                                </a>
                            </div>
                        </div>
                    `;

                    // 清空博饼区域的用户信息
                    userStatusDice.innerHTML = `
                        <div style="text-align: center; color: #999; padding: 20px;">
                            请登录后查看您的信息和参与博饼抽奖
                        </div>
                    `;
                    return;
                }

                // 已登录状态 - 计算总次数
                const totalTimes = currentUserInfo.defaultTimes + currentUserInfo.articleThankCnt;

                userStatusSection.innerHTML = `
                    <div class="user-card">
                        <div class="user-info">
                            <a href="${currentUserInfo.name ? ('https://fishpi.cn/member/' + encodeURIComponent(currentUserInfo.name)) : '/user/me'}" target="_blank" style="display:inline-flex; align-items:center; gap:12px; text-decoration:none; color:inherit;">
                                <img src="${currentUserInfo.avatar}" alt="avatar" class="user-avatar" onerror="this.src='https://file.fishpi.cn/default-avatar.png'">
                                <div class="user-details">
                                    <div class="user-nickname">${currentUserInfo.nickname || currentUserInfo.name}</div>
                                    <div class="user-name">@${currentUserInfo.name}</div>
                                    ${currentUserInfo.articleTitle ? `<div style="font-size: 12px; color: #1E9FFF; margin-top: 3px;"><a href=\"https://fishpi.cn/article/${currentUserInfo.articleOId}\" target=\"_blank\" style=\"color:#1E9FFF; text-decoration:none;\">📝 ${currentUserInfo.articleTitle}</a></div>` : ''}
                                </div>
                            </a>
                        </div>
                        <div class="times-info">
                            <div class="times-item">
                                <span>总次数：</span>
                                <span class="times-number">${totalTimes}</span>
                                <span style="font-size: 12px; opacity: 0.8;">(默认${currentUserInfo.defaultTimes} + 文章感谢${currentUserInfo.articleThankCnt})</span>
                            </div>
                            <div class="times-item">
                                <span>剩余次数：</span>
                                <span class="times-number" style="color: #FFD700;">${currentUserInfo.restTimes}</span>
                            </div>
                            <div class="times-item" style="font-size: 12px; opacity: 0.9;">
                                <span>已使用：${totalTimes - currentUserInfo.restTimes} 次</span>
                            </div>
                        </div>
                    </div>
                `;

                // 更新博饼区域的用户信息
                userStatusDice.innerHTML = `
                    <div class="dice-user-info">
                        <a href="${currentUserInfo.name ? ('https://fishpi.cn/member/' + encodeURIComponent(currentUserInfo.name)) : '/user/me'}" target="_blank" style="display:flex; align-items:center; gap:20px; text-decoration:none; color:inherit;">
                            <img src="${currentUserInfo.avatar}" alt="avatar" class="dice-user-avatar" onerror="this.src='https://file.fishpi.cn/default-avatar.png'">
                            <div class="dice-user-details">
                                <div class="dice-user-nickname">${currentUserInfo.nickname || currentUserInfo.name}</div>
                                <div class="dice-user-name">@${currentUserInfo.name}</div>
                            </div>
                        </a>
                        <div class="dice-times-info">
                            <div class="dice-times-item">
                                <div class="dice-times-label">总次数</div>
                                <div class="dice-times-number">${totalTimes}</div>
                            </div>
                            <div class="dice-times-item">
                                <div class="dice-times-label">剩余次数</div>
                                <div class="dice-times-number remaining">${currentUserInfo.restTimes}</div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // 检查 URL 参数
            function checkURLParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const from = urlParams.get('from');

                if(from === 'login') {
                    // 显示登录成功提示
                    layer.msg('登录成功', {icon: 1, time: 2000});
                } else if(from === 'register') {
                    // 显示注册提示弹窗
                    layer.open({
                        type: 1,
                        title: '欢迎参与活动',
                        area: ['450px', '280px'],
                        content: `
                            <div style="padding: 20px; text-align: center;">
                                <div style="font-size: 16px; color: #333; margin-bottom: 30px; line-height: 1.6;">
                                    发表文章后，才能参与博饼活动
                                </div>
                                <div style="display: flex; gap: 15px; justify-content: center;">
                                    <a href="https://fishpi.cn/article/1759997269582" target="_blank" class="layui-btn layui-btn-primary layui-btn-lg">
                                        <i class="layui-icon layui-icon-read"></i> 查看原文
                                    </a>
                                    <a href="https://fishpi.cn/post?type=0&tags=福签传情&title=【双节同庆】我的故事" target="_blank" class="layui-btn layui-btn-normal layui-btn-lg">
                                        <i class="layui-icon layui-icon-edit"></i> 发表文章
                                    </a>
                                </div>
                            </div>
                        `,
                        shadeClose: true,
                        btn: false
                    });
                }
            }

            // 页面初始化
            async function initPage() {
                // 检查登录状态
                const isLoggedIn = await checkLoginStatus();

                // 更新用户状态显示
                updateUserStatusDisplay();

                // 如果已登录，加载历史记录
                if (isLoggedIn) {
                    await loadHistoryFromServer();
                }

                // 检查URL参数
                checkURLParams();

                // 加载奖励数据
                loadRewards();

                // 渲染文章排行榜
                renderArticleTable();

                // 加载投票状态
                if (isLoggedIn) {
                    await loadVoteStatus();
                }
            }

            // 全局奖励数据
            let rewardsData = [];

            // 加载奖励列表
            function loadRewards() {
                fetch('/api/collections/rewards/records?expand=awards_via_rewardId&sort=-level')
                    .then(response => response.json())
                    .then(data => {
                        if(data.items && data.items.length > 0) {
                            rewardsData = data.items;
                            renderRewardsList();
                        }
                    })
                    .catch(error => {
                        console.error('加载奖励列表失败:', error);
                        layer.msg('奖励列表加载失败', {icon: 2});
                    });
            }

            // 渲染奖励列表
            function renderRewardsList() {
                const prizeTableBody = document.querySelector('.prize-table tbody');
                if(!prizeTableBody) return;

                prizeTableBody.innerHTML = '';

                if(rewardsData.length === 0) {
                    prizeTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #999; padding: 20px;">暂无奖励数据</td></tr>';
                    return;
                }

                rewardsData.forEach(reward => {
                    const awards = reward.expand && reward.expand.awards_via_rewardId ? reward.expand.awards_via_rewardId : [];
                    awards.sort((a, b) => (b.level || 0) - (a.level || 0));

                    if(awards.length === 0) {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td style="font-weight: bold; color: #FF5722; font-size: 16px; text-align: center; vertical-align: middle;">${reward.name}</td>
                            <td style="color: #999; text-align: center;">-</td>
                            <td style="color: #999; text-align: center;">-</td>
                            <td style="font-weight: 500; color: #1E9FFF; text-align: center;">${reward.point || 0}</td>
                            <td style="color: #999; text-align: center;">${reward.amount || '-'}</td>
                            <td style="color: #999; text-align: center; font-size: 12px;">${reward.more || '-'}</td>
                        `;
                        prizeTableBody.appendChild(row);
                        return;
                    }

                    awards.forEach((award, index) => {
                        const row = document.createElement('tr');

                        if(index === 0) {
                            const rewardCell = document.createElement('td');
                            rewardCell.rowSpan = awards.length;
                            rewardCell.style.cssText = 'font-weight: bold; color: #FF5722; font-size: 16px; text-align: center; vertical-align: middle; border-right: 2px solid #eee;';
                            rewardCell.textContent = reward.name;
                            row.appendChild(rewardCell);
                        }

                        const nameCell = document.createElement('td');
                        nameCell.style.cssText = 'font-weight: bold; color: #1E9FFF;';
                        nameCell.textContent = award.name || '-';
                        row.appendChild(nameCell);

                        const descCell = document.createElement('td');
                        descCell.style.cssText = 'font-size: 12px; color: #666;';
                        descCell.textContent = award.description || '-';
                        row.appendChild(descCell);

                        if(index === 0) {
                            const pointCell = document.createElement('td');
                            pointCell.rowSpan = awards.length;
                            pointCell.style.cssText = 'font-weight: 500; color: #1E9FFF; text-align: center; vertical-align: middle; font-size: 16px;';
                            pointCell.textContent = reward.point || 0;
                            row.appendChild(pointCell);

                            const amountCell = document.createElement('td');
                            amountCell.rowSpan = awards.length;
                            amountCell.style.cssText = 'font-weight: 500; color: #666; text-align: center; vertical-align: middle;';
                            amountCell.textContent = reward.amount || '-';
                            row.appendChild(amountCell);

                            const moreCell = document.createElement('td');
                            moreCell.rowSpan = awards.length;
                            moreCell.style.cssText = 'color: #999; text-align: left; vertical-align: middle; font-size: 12px;';
                            moreCell.textContent = reward.more || '-';
                            row.appendChild(moreCell);
                        }

                        prizeTableBody.appendChild(row);
                    });
                });
            }

            // 文章排行榜表格
            function renderArticleTable() {
                table.render({
                    elem: '#articleTable',
                    url: '/api/collections/articles/records?expand=userId&sort=-createdAt',
                    height: 500,
                    page: true,
                    limit: 10,
                    limits: [10, 20, 50, 100],
                    cols: [[
                        {field: 'title', title: '文章标题', width: 350, templet: function(d){
                            return '<a href="https://fishpi.cn/article/' + d.oId + '" target="_blank" style="color: #1E9FFF; text-decoration: none;">' + d.title + '</a>';
                        }},
                        {field: 'expand', title: '作者', width: 200, templet: function(d){
                            if(d.expand && d.expand.userId) {
                                const user = d.expand.userId;
                                const displayName = user.nickname || user.name || '-';
                                const memberName = user.name || '';
                                const avatar = user.avatar || '';
                                const avatarHtml = '<img src="' + avatar + '" alt="avatar" style="width: 30px; height: 30px; border-radius: 50%; object-fit: cover;" onerror="this.src=\'https://file.fishpi.cn/default-avatar.png\'" />';
                                if(memberName) {
                                    const memberUrl = 'https://fishpi.cn/member/' + encodeURIComponent(memberName);
                                    return '<a href="' + memberUrl + '" target="_blank" style="display: flex; align-items: center; gap: 8px; color: inherit; text-decoration: none;">' +
                                           avatarHtml +
                                           '<span>' + displayName + '</span>' +
                                           '</a>';
                                }
                                return '<div style="display: flex; align-items: center; gap: 8px;">' + avatarHtml + '<span>' + displayName + '</span></div>';
                            }
                            return '-';
                        }},
                        {field: 'viewCount', title: '浏览量', width: 100, sort: true},
                        {field: 'goodCnt', title: '点赞量', width: 100, sort: true},
                        {field: 'commentCount', title: '评论数', width: 100, sort: true},
                        {field: 'collectCnt', title: '收藏量', width: 100, sort: true},
                        {field: 'thankCnt', title: '感谢数', width: 100, sort: true},
                        {field: 'created', title: '创建时间', width: 180, sort: true, templet: function(d){
                            return formatDate(d.createdAt || d.created);
                         }},
                         {field: 'updated', title: '更新时间', width: 180, sort: true, templet: function(d){
                            return formatDate(d.updatedAt || d.updated);
                         }}
                    ]],
                    parseData: function(res){
                        return {
                            "code": 0,
                            "msg": "",
                            "count": res.totalItems,
                            "data": res.items
                        };
                    },
                    done: function(res, curr, count){
                        // 高亮当前用户的文章
                        if(currentUserInfo && currentUserInfo.articleId) {
                            res.data.forEach((item, index) => {
                                if(item.id === currentUserInfo.articleId) {
                                    const row = document.querySelector(`#articleTable + .layui-table-view .layui-table-body tr[data-index="${index}"]`);
                                    if(row) {
                                        row.classList.add('my-article-row');
                                    }
                                }
                            });
                        }
                    }
                });
            }

            // 博饼游戏逻辑
            let isRolling = false;
            let history = [];

            // 页面加载时获取历史记录
            async function loadHistoryFromServer() {
                if (!currentUserInfo) return;

                try {
                    const response = await fetch('/mooncake/history', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('获取到历史记录:', data);

                        // 转换服务器数据为前端格式
                        history = data.items.map(item => ({
                            time: formatDate(item.created),
                            result: {
                                dices: item.dices,
                                awardName: item.award_name,
                                prizeName: item.prize_name,
                                prizeLevel: item.prize_level
                            }
                        }));

                        updateHistoryDisplay();
                    }
                } catch (error) {
                    console.error('加载历史记录失败:', error);
                }
            }

            document.getElementById('rollBtn').addEventListener('click', async function(){
                if(isRolling) return;

                // 检查用户是否登录
                if(!currentUserInfo) {
                    layer.confirm('您还未登录，是否前往登录？', {
                        icon: 3,
                        title: '提示',
                        btn: ['去登录', '取消']
                    }, function(index){
                        window.location.href = '/fishpi/login';
                        layer.close(index);
                    });
                    return;
                }

                // 检查用户剩余博饼次数
                if(currentUserInfo.restTimes <= 0) {
                    layer.msg('您的博饼次数已用完，请明天再来吧！', {icon: 2, time: 2000});
                    return;
                }

                isRolling = true;
                const rollButton = document.getElementById('rollBtn');
                rollButton.disabled = true;

                try {
                    // 调用服务器博饼接口
                    console.log('正在调用博饼接口...');
                    const response = await fetch('/mooncake/gambling', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if(!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.message || '博饼请求失败');
                    }

                    const result = await response.json();
                    console.log('博饼结果:', result);

                    // 显示骰子动画
                    const dices = document.querySelectorAll('.dice');
                    dices.forEach(dice => {
                        dice.textContent = '?';
                        dice.classList.add('rolling');
                    });

                    // 1秒后依次显示结果
                    setTimeout(() => {
                        let completedCount = 0;

                        dices.forEach((dice, index) => {
                            setTimeout(() => {
                                dice.classList.remove('rolling');
                                dice.innerHTML = `<img src="data:image/svg+xml;base64,${getDiceSVGBase64(result.dices[index])}" alt="dice-${result.dices[index]}" style="width: 60px; height: 60px;" />`;

                                completedCount++;

                                if(completedCount === 6) {
                                    // 更新剩余次数
                                    currentUserInfo.restTimes = result.rest_times;
                                    updateUserStatusDisplay();

                                    // 添加到历史记录（前端显示）
                                    addHistory({
                                        dices: result.dices,
                                        awardName: result.award_name,
                                        prizeName: result.prize_name,
                                        prizeLevel: result.prize_level
                                    });

                                    isRolling = false;
                                    rollButton.disabled = false;

                                    // 显示提示（包含奖项名称）
                                    setTimeout(() => {
                                        let message = '科考结果：' + result.award_name;
                                        if (result.reward_name) {
                                            message += ' - ' + result.reward_name;
                                        }
                                        layer.msg(message, {icon: 1, time: 3000});
                                    }, 200);
                                }
                            }, index * 200);
                        });
                    }, 1000);

                } catch(error) {
                    console.error('博饼失败:', error);
                    layer.msg(error.message || '博饼失败，请稍后重试', {icon: 2});
                    isRolling = false;
                    rollButton.disabled = false;
                }
            });

            // 添加历史记录
            function addHistory(result) {
                const now = new Date();
                history.unshift({
                    time: formatDate(now),
                    result: result
                });

                if(history.length > 20) {
                    history = history.slice(0, 20);
                }

                updateHistoryDisplay();
            }

            // 更新历史记录显示
            function updateHistoryDisplay() {
                const historyList = document.getElementById('historyList');
                if(history.length === 0) {
                    historyList.innerHTML = '<div style="text-align: center; color: #999; padding: 20px;">暂无记录，快来试试手气吧！</div>';
                    return;
                }

                historyList.innerHTML = history.map(h => `
                    <div class="history-item">
                        <div class="history-time">${h.time}</div>
                        <div class="history-result">${h.result.awardName} - ${h.result.prizeName}</div>
                        <div class="history-dices" style="display: flex; align-items: center; gap: 3px;">
                            ${h.result.dices.map(d => `<img src="data:image/svg+xml;base64,${getDiceSVGBase64(d)}" alt="dice-${d}" class="dice-svg" />`).join('')}
                        </div>
                    </div>
                `).join('');
            }

            // 格式化日期
            function formatDate(date) {
                if(!date) return '-';
                try {
                    if(typeof date === 'string') {
                        let s = date.trim();
                        if(s.indexOf('T') === -1 && s.indexOf(' ') !== -1) {
                            s = s.replace(' ', 'T');
                        }
                        date = new Date(s);
                    }

                    if(!(date instanceof Date) || isNaN(date.getTime())) return '-';

                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hour = String(date.getHours()).padStart(2, '0');
                    const minute = String(date.getMinutes()).padStart(2, '0');
                    const second = String(date.getSeconds()).padStart(2, '0');
                    return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
                } catch (e) {
                    return '-';
                }
             }

            // 获取骰子SVG的Base64编码
            function getDiceSVGBase64(d) {
                const svgs = {
                    1: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="50" cy="50" r="8" fill="red"/></svg>`,
                    2: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="#333"/><circle cx="70" cy="70" r="8" fill="#333"/></svg>`,
                    3: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="#333"/><circle cx="50" cy="50" r="8" fill="#333"/><circle cx="70" cy="70" r="8" fill="#333"/></svg>`,
                    4: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="red"/><circle cx="70" cy="30" r="8" fill="red"/><circle cx="30" cy="70" r="8" fill="red"/><circle cx="70" cy="70" r="8" fill="red"/></svg>`,
                    5: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="30" r="8" fill="#333"/><circle cx="70" cy="30" r="8" fill="#333"/><circle cx="50" cy="50" r="8" fill="#333"/><circle cx="30" cy="70" r="8" fill="#333"/><circle cx="70" cy="70" r="8" fill="#333"/></svg>`,
                    6: `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect width="100" height="100" rx="15" fill="#fff" stroke="#333" stroke-width="2"/><circle cx="30" cy="25" r="8" fill="#333"/><circle cx="70" cy="25" r="8" fill="#333"/><circle cx="30" cy="50" r="8" fill="#333"/><circle cx="70" cy="50" r="8" fill="#333"/><circle cx="30" cy="75" r="8" fill="#333"/><circle cx="70" cy="75" r="8" fill="#333"/></svg>`
                };

                return btoa(unescape(encodeURIComponent(svgs[d])));
            }

            // 加载投票状态
            async function loadVoteStatus() {
                const voteStatusCards = document.getElementById('voteStatusCards');

                if (!currentUserInfo) {
                    voteStatusCards.innerHTML = '<div style="color: white; text-align: center; width: 100%;">请登录后查看您的投票状态</div>';
                    return;
                }

                try {
                    const response = await fetch('/vote/statistics', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        console.log('投票统计:', data);

                        const voteTypes = [
                            { type: 'career', name: '事业符', icon: '💼', voted: data.career_voted },
                            { type: 'romance', name: '姻缘符', icon: '💕', voted: data.romance_voted },
                            { type: 'wealth', name: '招财符', icon: '💰', voted: data.wealth_voted }
                        ];

                        voteStatusCards.innerHTML = voteTypes.map(vt => `
                            <div class="vote-card ${vt.voted ? 'voted' : ''}" data-vote-type="${vt.type}">
                                <div class="vote-card-icon">${vt.icon}</div>
                                <div class="vote-card-name">${vt.name}</div>
                                <div class="vote-card-status">${vt.voted ? '已赠送' : '可赠送'}</div>
                            </div>
                        `).join('');

                        // 为未投票的卡片添加点击事件
                        voteTypes.forEach(vt => {
                            if (!vt.voted) {
                                const card = document.querySelector(`.vote-card[data-vote-type="${vt.type}"]`);
                                if (card) {
                                    card.style.cursor = 'pointer';
                                    card.addEventListener('click', () => showVoteDialog(vt.type, vt.name));
                                }
                            }
                        });
                    }

                    // 加载排行榜和个人记录
                    await loadVoteRank();
                    await loadMyVotes();

                } catch (error) {
                    console.error('加载投票状态失败:', error);
                    voteStatusCards.innerHTML = '<div style="color: white; text-align: center; width: 100%;">加载失败，请刷新重试</div>';
                }
            }

            // 显示投票对话框
            function showVoteDialog(voteType, voteName) {
                if (!currentUserInfo) {
                    layer.msg('请先登录', {icon: 2});
                    return;
                }

                // 获取所有文章列表
                fetch('/api/collections/articles/records?expand=userId&sort=-createdAt&perPage=100')
                    .then(response => response.json())
                    .then(data => {
                        const articles = data.items || [];

                        if (articles.length === 0) {
                            layer.msg('暂无文章可供投票', {icon: 2});
                            return;
                        }

                        // 构建文章选择列表，保留自己的文章但添加蒙版
                        const articleListHtml = articles.map((article, index) => {
                            const user = article.expand && article.expand.userId ? article.expand.userId : {};
                            const displayName = user.nickname || user.name || '未知用户';
                            const isMyArticle = article.userId === currentUserInfo.id;

                            // 自己的文章添加蒙版样式
                            if (isMyArticle) {
                                return `
                                    <div class="article-select-item" style="padding: 10px; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 10px; position: relative; opacity: 0.5; cursor: not-allowed;">
                                        <a href="https://fishpi.cn/article/${article.oId}" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex;align-items:center; gap:8px; text-decoration:none; color:inherit;">
                                            <img src="${user.avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                                        </a>
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #999;"><a href="https://fishpi.cn/article/${article.oId}" target="_blank" onclick="event.stopPropagation()" style="color: #999; text-decoration: none;">${article.title}</a></div>
                                            <div style="font-size: 12px; color: #bbb;">作者: <a href="${user.name ? ('https://fishpi.cn/member/' + encodeURIComponent(user.name)) : '#'}" target="_blank" onclick="event.stopPropagation()" style="color:#bbb; text-decoration:none;">${displayName}</a></div>
                                        </div>
                                        <div style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background: rgba(255, 255, 255, 0.85); display: flex; align-items: center; justify-content: center; border-radius: 4px;">
                                            <div style="background: linear-gradient(135deg, #FFB800 0%, #FF8C00 100%); color: white; padding: 8px 16px; border-radius: 20px; font-size: 13px; font-weight: bold; box-shadow: 0 2px 8px rgba(255, 184, 0, 0.3);">
                                                <i style="margin-right: 5px;">✋</i> 温馨提示：把机会留给其他作者吧~
                                            </div>
                                        </div>
                                    </div>
                                `;
                            }

                            // 其他人的文章正常显示
                            return `
                                <div class="article-select-item" data-article-id="${article.id}" data-article-title="${article.title.replace(/\"/g, '&quot;')}" style="padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;">
                                    <a href="https://fishpi.cn/article/${article.oId}" target="_blank" onclick="event.stopPropagation()" style="display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:inherit;">
                                        <img src="${user.avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                                        <div style="flex: 1;">
                                            <div style="font-weight: bold; color: #333;">${article.title}</div>
                                            <div style="font-size: 12px; color: #999;">作者: <a href="${user.name ? ('https://fishpi.cn/member/' + encodeURIComponent(user.name)) : '#'}" target="_blank" onclick="event.stopPropagation()" style="color:#1E9FFF; text-decoration:none;">${displayName}</a></div>
                                        </div>
                                    </a>
                                </div>
                            `;
                        }).join('');

                        layer.open({
                            type: 1,
                            title: `赠送${voteName}`,
                            area: ['600px', '500px'],
                            content: `
                                <div style="padding: 20px;">
                                    <div style="margin-bottom: 15px; color: #666;">
                                        选择一篇文章赠送${voteName}
                                    </div>
                                    <div id="articleSelectList" style="max-height: 350px; overflow-y: auto; border: 1px solid #eee; border-radius: 4px;">
                                        ${articleListHtml}
                                    </div>
                                </div>
                            `,
                            success: function(layero, index) {
                                // 使用原生JavaScript添加事件
                                const container = document.getElementById('articleSelectList');
                                if (!container) return;

                                const items = container.querySelectorAll('.article-select-item[data-article-id]');
                                items.forEach(item => {
                                    // 点击事件
                                    item.addEventListener('click', function() {
                                        const articleId = this.getAttribute('data-article-id');
                                        const articleTitle = this.getAttribute('data-article-title');

                                        layer.confirm(`确认要将${voteName}赠送给这篇文章吗？<br><br>"${articleTitle}"`, {
                                            icon: 3,
                                            title: '确认赠送',
                                            btn: ['确认', '取消']
                                        }, function(confirmIndex) {
                                            submitVote(articleId, voteType, voteName);
                                            layer.close(confirmIndex);
                                            layer.close(index);
                                        });
                                    });

                                    // 悬停效果
                                    item.addEventListener('mouseenter', function() {
                                        this.style.background = '#f8f9fa';
                                    });
                                    item.addEventListener('mouseleave', function() {
                                        this.style.background = 'white';
                                    });
                                });
                            }
                        });
                    })
                    .catch(error => {
                        console.error('加载文章列表失败:', error);
                        layer.msg('加载文章列表失败', {icon: 2});
                    });
            }

            // 提交投票
            async function submitVote(articleId, voteType, voteName) {
                try {
                    const response = await fetch('/vote', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include',
                        body: JSON.stringify({
                            article_id: articleId,
                            vote_type: voteType
                        })
                    });

                    if (response.ok) {
                        const result = await response.json();
                        layer.msg(`${voteName}赠送成功！`, {icon: 1, time: 2000});

                        // 刷新投票状态
                        await loadVoteStatus();
                    } else {
                        const error = await response.json();
                        layer.msg(error.message || '赠送失败', {icon: 2});
                    }
                } catch (error) {
                    console.error('投票失败:', error);
                    layer.msg('网络错误，请稍后重试', {icon: 2});
                }
            }

            // 撤销投票
            async function revokeVote(voteId, voteName) {
                layer.confirm(`确定要撤销${voteName}的赠送吗？`, {
                    icon: 3,
                    title: '确认撤销',
                    btn: ['确认', '取消']
                }, async function(index) {
                    try {
                        const response = await fetch(`/vote/${voteId}`, {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include'
                        });

                        if (response.ok) {
                            layer.msg('撤销成功！', {icon: 1, time: 2000});
                            await loadVoteStatus();
                        } else {
                            const error = await response.json();
                            layer.msg(error.message || '撤销失败', {icon: 2});
                        }
                    } catch (error) {
                        console.error('撤销失败:', error);
                        layer.msg('网络错误，请稍后重试', {icon: 2});
                    }
                    layer.close(index);
                });
            }

            // 将revokeVote暴露到全局作用域
            window.revokeVote = revokeVote;

            // 加载投票排行榜 - 拆分为三个单项榜单
            async function loadVoteRank() {
                try {
                    const response = await fetch('/vote/rank', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const items = data.items || [];

                        if (items.length === 0) {
                            renderEmptyRank('careerRankList');
                            renderEmptyRank('romanceRankList');
                            renderEmptyRank('wealthRankList');
                            return;
                        }

                        // 按事业符、姻缘符、招财符分别排序，取前3名
                        const careerRank = [...items].sort((a, b) => b.career_count - a.career_count).filter(item => item.career_count > 0).slice(0, 3);
                        const romanceRank = [...items].sort((a, b) => b.romance_count - a.romance_count).filter(item => item.romance_count > 0).slice(0, 3);
                        const wealthRank = [...items].sort((a, b) => b.wealth_count - a.wealth_count).filter(item => item.wealth_count > 0).slice(0, 3);

                        renderRankList('careerRankList', careerRank, 'career', '💼');
                        renderRankList('romanceRankList', romanceRank, 'romance', '💕');
                        renderRankList('wealthRankList', wealthRank, 'wealth', '💰');
                    }
                } catch (error) {
                    console.error('加载投票排行榜失败:', error);
                    renderEmptyRank('careerRankList', '加载失败');
                    renderEmptyRank('romanceRankList', '加载失败');
                    renderEmptyRank('wealthRankList', '加载失败');
                }
            }

            // 渲染单个排行榜
            function renderRankList(containerId, items, type, icon) {
                const container = document.getElementById(containerId);
                if (!container) return;

                if (items.length === 0) {
                    renderEmptyRank(containerId);
                    return;
                }

                const countField = type + '_count';

                container.innerHTML = items.map((item, index) => {
                    const rank = index + 1;
                    let rankBadgeClass = 'rank-other';
                    if (rank === 1) rankBadgeClass = 'rank-1';
                    else if (rank === 2) rankBadgeClass = 'rank-2';
                    else if (rank === 3) rankBadgeClass = 'rank-3';

                    const memberHref = item.user_name ? ('https://fishpi.cn/member/' + encodeURIComponent(item.user_name)) : '#';

                    return `
                        <div style="background: white; border-radius: 6px; padding: 12px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.08);">
                            <span class="rank-badge ${rankBadgeClass}" style="flex-shrink: 0;">${rank}</span>
                            <a href="${memberHref}" target="_blank" style="display:inline-flex; align-items:center; gap:10px; text-decoration:none; color:inherit; flex-shrink:0;">
                                <img src="${item.user_avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                            </a>
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: bold; color: #333; font-size: 14px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;"><a href="${memberHref}" target="_blank" style="color:inherit; text-decoration:none;">${item.user_nickname || item.user_name}</a></div>
                                <div style="font-size: 11px; color: #1E9FFF; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                    <a href="https://fishpi.cn/article/${item.article_oid}" target="_blank" style="color: inherit; text-decoration: none;" title="${item.article_title}">${item.article_title}</a>
                                </div>
                            </div>
                            <div style="text-align: center; flex-shrink: 0;">
                                <div style="font-size: 20px; font-weight: bold; color: #FF5722;">${item[countField]}</div>
                                <div style="font-size: 11px; color: #999;">${icon} 票数</div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // 渲染空排行榜
            function renderEmptyRank(containerId, message = '暂无数据') {
                const container = document.getElementById(containerId);
                if (!container) return;
                container.innerHTML = `<div style="text-align: center; color: #999; padding: 20px;">${message}</div>`;
            }

            // 加载我的投票记录
            async function loadMyVotes() {
                const myVoteRecords = document.getElementById('myVoteRecords');

                if (!currentUserInfo) {
                    myVoteRecords.innerHTML = '<div style="text-align: center; padding: 20px;">请登录后查看您的投票记录</div>';
                    return;
                }

                try {
                    const response = await fetch('/vote/my', {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        credentials: 'include'
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const items = data.items || [];

                        if (items.length === 0) {
                            myVoteRecords.innerHTML = '<div style="text-align: center; padding: 20px;">您还没有赠送过福签</div>';
                            return;
                        }

                        const voteTypeMap = {
                            'career': { name: '事业符', icon: '💼' },
                            'romance': { name: '姻缘符', icon: '💕' },
                            'wealth': { name: '招财符', icon: '💰' }
                        };

                        myVoteRecords.innerHTML = `
                            <div style="display: flex; flex-wrap: wrap; gap: 15px;">
                                ${items.map(item => {
                                    const voteInfo = voteTypeMap[item.vote_type] || { name: '未知', icon: '❓' };
                                    const memberHref = item.to_user_name ? ('https://fishpi.cn/member/' + encodeURIComponent(item.to_user_name)) : '#';
                                    return `
                                        <div style="background: #f8f9fa; border-radius: 8px; padding: 15px; flex: 1; min-width: 250px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: relative;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                                <span style="font-size: 24px;">${voteInfo.icon}</span>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold; color: #333;">${voteInfo.name}</div>
                                                    <div style="font-size: 11px; color: #999;">${formatDate(item.created)}</div>
                                                </div>
                                                <button class="layui-btn layui-btn-xs layui-btn-danger" onclick="revokeVote('${item.id}', '${voteInfo.name}')" style="position: absolute; top: 10px; right: 10px;">
                                                    <i class="layui-icon layui-icon-close"></i> 撤销
                                                </button>
                                            </div>
                                            <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: white; border-radius: 4px;">
                                                <a href="${memberHref}" target="_blank" style="display:inline-block;">
                                                    <img src="${item.to_user_avatar || 'https://file.fishpi.cn/default-avatar.png'}" alt="avatar" style="width: 35px; height: 35px; border-radius: 50%; object-fit: cover;" onerror="this.src='https://file.fishpi.cn/default-avatar.png'" />
                                                </a>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: bold; color: #333; font-size: 13px;"><a href="${memberHref}" target="_blank" style="color:inherit; text-decoration:none;">${item.to_user_nick || item.to_user_name}</a></div>
                                                    <div style="font-size: 11px; color: #1E9FFF;">
                                                        <a href="https://fishpi.cn/article/${item.article_oid}" target="_blank" style="color: inherit; text-decoration: none;" title="${item.article_title}">${item.article_title.substring(0, 25)}${item.article_title.length > 25 ? '...' : ''}</a>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                    }
                } catch (error) {
                    console.error('加载我的投票记录失败:', error);
                    myVoteRecords.innerHTML = '<div style="text-align: center; padding: 20px; color: #f56c6c;">加载失败，请刷新重试</div>';
                }
            }

            // 页面加载时初始化
            initPage();
        });
    </script>
</body>
</html>
